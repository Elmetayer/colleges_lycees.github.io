---
title: "Classement des Collèges et Lycées"
author: "Bruno Lemetayer"
date: "`r Sys.Date()`"
output: rmdformats::robobook
---

```{r "paramétrage", include=FALSE}

library(leaflet)
library(tidyverse)
library(htmltools)
library(crosstalk)
library(downloadthis)

# paramètres
annnee_min <- 2024

```

```{r "données geolocalisation", include=FALSE}

# données géolocalisation
cols_geo <- c(
  "numero_uai",
  "adresse_uai",
  "code_postal_uai",
  "libelle_commune",
  "latitude",
  "longitude",
  "code_departement",
  "code_region",
  "code_academie",
  "code_commune"  
)
df_geo <- read.csv2("data_raw/fr-en-adresse-et-geolocalisation-etablissements-premier-et-second-degre.csv") %>% 
  select(cols_geo) %>% 
  mutate(
    latitude = as.numeric(latitude),
    longitude = as.numeric(longitude)
  )

```

```{r "données communes", include=FALSE}

df_communes <- read.csv2("data_raw/codes_postaux.csv", fileEncoding = "latin1")

```

```{r "données lycées", include=FALSE}

# données lycées
cols_lycee <- c(
  "Année",
  "UAI",
  "Etablissement",
  "Secteur",
  "Code.commune",
  "Commune",
  "Code.departement",
  "Département",
  "Académie",
  "Code.région",
  "Region",
  "Présents...Gnle",
  "Taux.de.réussite...Gnle",
  "Taux.d.accès.2nde.bac",
  "Taux.d.accès.1ere.bac",
  "Taux.d.accès.terminale.bac",
  "Taux.de.mentions...Gnle",
  "Valeur.ajoutée.du.taux.de.mentions...Gnle",
  "Valeur.ajoutée.du.taux.de.réussite...Gnle",
  "Valeur.ajoutée.du.taux.d.acces.2nde.bac",
  "Valeur.ajoutée.du.taux.d.accès.1ere.bac",
  "Valeur.ajoutée.du.taux.d.accès.terminale.bac",
  "Présents...Toutes.séries"
  )
df_lycee <- read.csv2("data_raw/fr-en-indicateurs-de-resultat-des-lycees.csv") %>% 
  select(cols_lycee) %>% 
  left_join(
    df_geo,
    by = c("UAI" = "numero_uai")
  ) %>% 
  filter(
    !is.na(Taux.de.réussite...Gnle),
    !is.na(Taux.de.mentions...Gnle)) %>% 
  mutate(
    type = "lycée",
    Secteur = ifelse(Secteur == "public", Secteur, "privé"),
    score = rowSums(across(
      c("Taux.de.réussite...Gnle",
  "Taux.d.accès.2nde.bac",
  "Taux.d.accès.1ere.bac",
  "Taux.d.accès.terminale.bac",
  "Taux.de.mentions...Gnle"), 
  ~(as.numeric(.x)/100)))) %>% 
  group_by(Année) %>% 
  arrange(desc(score)) %>% 
  mutate(
    classement = row_number(),
    nb = n()) %>% 
  ungroup() %>% 
  rename(eleves = Présents...Toutes.séries) %>% 
    select(Année, latitude, longitude, Etablissement, type, Secteur, Commune, code_departement, score, classement, nb, eleves)

```

```{r "données collège", include=FALSE}

# données collèges
cols_college <- c(
  "Session",
  "UAI",
  "Nom.de.l.établissement",
  "Commune",
  "Département",
  "Académie",
  "Secteur",
  "Nb.candidats.G",
  "Taux.de.réussite.G",
  "VA.du.taux.de.réussite.G",
  "Note.à.l.écrit.G",
  "VA.de.la.note.G",
  "Taux.d.accès.6eme.3eme",
  "Part.présents.3eme.ordinaire.G",
  "Nb.mentions.global.G",
  "Nb.candidats.G"
)

df_college <- read.csv2("data_raw/fr-en-indicateurs-valeur-ajoutee-colleges.csv") %>% 
  select(cols_college) %>% 
  left_join(
    df_geo,
    by = c("UAI" = "numero_uai")
  ) %>% 
  filter(
    !is.na(Taux.de.réussite.G),
    !is.na(Nb.mentions.global.G)) %>% 
  mutate(
    type = "collège",
    Secteur = ifelse(Secteur == "PU", "public", "privé"),
    Taux.de.mentions.Gnle = (Nb.mentions.global.G / Nb.candidats.G)*100,
    score = rowSums(across(
      c("Taux.de.réussite.G",
  "Taux.de.mentions.Gnle"), 
  ~(as.numeric(.x)/100)))) %>% 
  group_by(Session) %>% 
  arrange(desc(score)) %>% 
  mutate(
    classement = row_number(),
    nb = n()) %>% 
  ungroup() %>% 
  rename(
    Année = Session, 
    Etablissement = Nom.de.l.établissement,
    eleves = Nb.candidats.G) %>% 
    select(Année, latitude, longitude, Etablissement, type, Secteur, Commune, code_departement, score, classement, nb, eleves)

# données anciennes
df_college_old <- read.csv2("data_raw/fr-en-dnb-par-etablissement.csv") %>% 
  left_join(
    df_geo,
    by = c("Numero.d.etablissement" = "numero_uai")
  ) %>% 
  left_join(
    df_communes %>% 
      select(X.Code_commune_INSEE, Nom_de_la_commune) %>% 
      unique(),
    by = c("Commune" = "X.Code_commune_INSEE")
  ) %>% 
  filter(
    Commune != "-",
    !is.na(Admis),
    !is.na(Admis.sans.mention),
    !is.na(Presents)) %>% 
  mutate(
    type = "collège",
    Secteur = ifelse(Secteur.d.enseignement == "PUBLIC", "public", "privé"),
    score = Admis/Presents + 1 - Admis.sans.mention/Admis) %>% 
  group_by(Session) %>% 
  arrange(desc(score)) %>% 
  mutate(
    Commune = Nom_de_la_commune,
    classement = row_number(),
    nb = n()) %>% 
  ungroup() %>% 
  rename(
    Année = Session, 
    Etablissement = Patronyme,
    eleves = Inscrits) %>% 
    select(Année, latitude, longitude, Etablissement, type, Secteur, Commune, code_departement, score, classement, nb, eleves)

```

```{r "données école", include=FALSE}

# données école
cols_ecole <- c(
  "latitude",
  "longitude",
  "secteur_public_prive_libe",
  "libelle_commune",
  "code_departement"
)

df_ecole <- read.csv2("data_raw/fr-en-adresse-et-geolocalisation-etablissements-premier-et-second-degre.csv") %>% 
  filter(
    grepl("ECOLE.*", nature_uai_libe)) %>% 
  select(cols_ecole)

```

# Carte

```{r "carte", echo=FALSE, warning=FALSE}

# df pour l'affichage carte
df_carte <- rbind(
  df_college,
  df_college_old,
  df_lycee) %>%
  filter(
    !is.na(latitude),
    !is.na(longitude)
  ) %>% 
  mutate(
    Année = as.numeric(Année),
    score = round(score, 2),
    color_rank = (nb-classement)/nb)

# palette de couleurs sur le score
# qpal <- colorQuantile("RdYlBu", df_carte$color_rank, 10)
qpal <- colorNumeric("RdYlBu", c(0, 1))

# carte avec filtres interactifs
sd_carte <- SharedData$new(df_carte)
bscols(
  widths = c(2, 3, 3, 3, 3),
  filter_select("filter_annee", "Annee", sd_carte, ~ Année, multiple = FALSE),
  filter_select("filter_type", "Type", sd_carte, ~ type),
  filter_select("filter_secteur", "Secteur", sd_carte, ~ Secteur),
  filter_select("filter_dept", "Département", sd_carte, ~ code_departement),
  filter_select("filter_commune", "Commune", sd_carte, ~ Commune))
bscols(
  leaflet(sd_carte) %>% 
    addTiles() %>%
    addCircleMarkers(
      lng = ~ longitude,
      lat = ~ latitude,
      label = ~ htmlEscape(Etablissement),
      popup = ~ paste(
        Année,
        "<br/>",
        Etablissement,
        "<br/>",
        eleves,
        "<br/>",
        Commune, paste0("(", code_departement, ")"),
        "<br/>",
        Secteur,
        "<br/>",
        score, paste0("(", classement, "/", nb, ")")
      ),
      radius = 10,
      fillColor = ~ qpal(color_rank),
      color = "black",
      weight = 0.6,
      fillOpacity = 0.9
    ) %>% 
    fitBounds(
      lng1 = ~min(longitude),
      lat1 = ~min(latitude), 
      lng2 = ~max(longitude), 
      lat2 = ~max(latitude))
)

```

# Données

```{r "données carte", echo=FALSE, warning=FALSE}

df_carte %>%
  download_this(
    output_name = "cartes_colleges_lycees",
    output_extension = ".csv",
    button_label = "données carte csv",
    button_type = "default",
    has_icon = TRUE,
    icon = "fa fa-save"
  )

```

# Sources

Géolocalisation des établissements : [data.education.gouv.fr](https://data.education.gouv.fr/explore/dataset/fr-en-adresse-et-geolocalisation-etablissements-premier-et-second-degre)

Indicateurs de valeur ajoutée des collèges (2022 et après) : [data.education.gouv.fr](https://data.education.gouv.fr/explore/dataset/fr-en-indicateurs-valeur-ajoutee-colleges)

Résultats au brevet (2021 et avant) :
[data.education.gouv.fr](https://data.education.gouv.fr/explore/dataset/fr-en-dnb-par-etablissement)

Indicateurs de valeur ajoutée des lycées d'enseignement général et technologique :
[data.education.gouv.fr](https://data.education.gouv.fr/explore/dataset/fr-en-indicateurs-de-resultat-des-lycees-gt_v2)

# Méthodologie

## Lycées

Le score est calculé en faisant la somme des pourcentages suivants pour la filière "générale":

+ Taux de réussite au bac
+ Taux de mentions au bac
+ Taux d'accès au bac à partir de la seconde
+ Taux d'accès au bac à partir de la première
+ Taux d'accès au bac à partir de la terminale

Données palmarès Le Figaro :

+ Taux de réussite au bac, voie générale (avec valeur ajoutée)
+ Taux de mentions au bac, voie générale (avec valeur ajoutée)
+ Taux d'accès au bac depuis la 2nde
+ Taux d'accès au bac depuis la 1ere
+ Taux d'accès au bac depuis la Tale

## Collèges

Le score est calculé en faisant la somme des pourcentages suivants pour la filière "générale":

+ Taux de réussite au brevet
+ Taux de mentions au brevet
+ Taux d'accès à la 3eme depuis la 6e

Données palmarès Le Figaro :

+ Note moyenne aux épreuves écrites (avec valeur ajoutée)
+ Taux d'accès à la 3e depuis la 6e
+ Part d'élèves de 3e présents au brevet
+ Taux de réussite au brevet
